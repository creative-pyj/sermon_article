{% load static %}
<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>招待教会讲道</title>
     <link rel="stylesheet" href="{% static 'articles/css/sermon_article.css' %}">
    <style>
        .mobile-text { display: none; }
        .pc-text { display: inline; }

        @media (max-width: 1024px) {
            .mobile-text { display: inline; }
            .pc-text { display: none; }
        }
     </style>
  </head>
  <body class="{% if is_mobile %}mobile-view{% else %}pc-view{% endif %}">
    
    <div class="sidebar" id="sidebar">
      <div class="brand-header">招待教会讲道</div>
      
      <div class="search-container">
        <div class="search-box-wrapper">
          <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M21.71 20.29l-5.01-5.01C17.54 13.68 18 11.91 18 10c0-4.41-3.59-8-8-8S2 5.59 2 10s3.59 8 8 8c1.91 0 3.68-.46 5.28-1.28l5.01 5.01c.39.39 1.02.39 1.41 0 .39-.38.39-1.01.01-1.4z"/>
          </svg>
          
          <input
            type="search"
            id="search-Input"
            class="s-input"
            placeholder="查找讲道..."
          />
          
          <div class="mobile-toggle-btn" onclick="toggleArticleList()">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="#666">
              <path d="M7 10l5 5 5-5z"/>
            </svg>
          </div>
        </div>
      </div>
      
      <div id="articleList" class="article-list-container">
      {% for article in articles %}
        <div class="article-item" onclick="loadDetail('{{ article.id }}')">
        
          <div class="list-image-container">
              {% if article.member and article.member.image %}
                <img src="static/articles/images{{ article.member.image.url }}" alt="{{ article.member.name }}">
              {% else %}
                <img src="{% static 'articles/images/default_user.png' %}" alt="No Image"> 
              {% endif %}

              <div class="member-info-tooltip">
                {% if article.member %}
                  {{ article.member.name }} 
                  {% if article.member.kana %}({{ article.member.kana }}){% endif %}
                  <br>
                  {{ article.member.get_role_display }}
                {% else %}
                  Unknown
                {% endif %}
              </div>
          </div>

          <div class="list-content">
            <div class="list-meta">
              <div style="color: #666; font-size: 0.85rem; line-height: 1.4;">
                {{ article.sermon_at|date:"Y年m月d日 H:i" }}
              </div>
            </div>

            <div class="list-title" style="margin-top: 2px;">
              {{ article.content_title }}
            </div>

            <div style="margin-top: 2px; text-align: right; color: #888; font-size: 0.85rem; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
              {{ article.content_summary }}
            </div>

          </div>

        </div>
      {% endfor %}
      </div>
    </div>

    <div class="content-area">
      <div class="status-bar" id="status-text">显示中：---</div>
        <div id="displayArea" class="disp_area">
          <h2 class="text-muted card_title1">
              {% if is_mobile %}
                  在搜索框选择讲道
              {% else %}
                  在左边栏中选择讲道
              {% endif %}
          </h2>
        </div>
    </div>

<script>
    const statusText = document.getElementById("status-text");
    const articleListDiv = document.getElementById("articleList");
    
    const initialMessage = "{% if is_mobile %}在搜索框选择讲道{% else %}在左边栏中选择讲道{% endif %}";
    const defaultUserImage = "{% static 'articles/images/default_user.png' %}";
    
    function toggleArticleList() {
        articleListDiv.classList.toggle("show");
    }

    function createListItemHtml(item) {
        const imgUrl = item.member_image ? item.member_image : defaultUserImage;
        const kanaStr = item.member_kana ? `(${item.member_kana})` : "";
        const roleStr = item.member_role ? `/ ${item.member_role}` : "";
        
        const tooltipHtml = `
            <div class="member-info-tooltip">
                ${item.member_name || 'Unknown'} ${kanaStr}<br>
                ${roleStr}
            </div>
        `;

        // ▼▼▼ 修正：要約HTMLの生成（スタイル付き） ▼▼▼
        const summaryHtml = item.content_summary 
            ? `<div style="margin-top: 2px; text-align: right; color: #888; font-size: 0.85rem; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${item.content_summary}</div>`
            : "";
        
        return `
            <div class="article-item" onclick="loadDetail('${item.id}')">
              
              <div class="list-image-container">
                <img src="static/articles/images${imgUrl}" alt="${item.member_name}">
                ${tooltipHtml}
              </div>

              <div class="list-content">
                <div class="list-meta">
                  <div style="color: #666; font-size: 0.85rem; line-height: 1.4;">
                    ${item.sermon_at}
                  </div>
                </div>

                <div class="list-title" style="margin-top: 2px;">
                  ${item.content_title}
                </div>
                
                ${summaryHtml}

              </div>
            </div>
        `;
    }
    
    // （以下、他の関数は変更なしのため省略可能ですが、念のため全体を載せています）
    function getInitialMessage() {
        if (window.innerWidth <= 1024) {
            return "在搜索框选择讲道"; 
        } else {
            return "在左边栏中选择讲道";
        }
    }

    function resetToInitial() {
        fetch("/search") 
          .then((res) => res.json())
          .then((data) => {
            articleListDiv.innerHTML = "";
            statusText.innerHTML = "显示中：---";
            const msg = getInitialMessage();
            document.getElementById("displayArea").innerHTML = `<h2 class='text-muted card_title1'>${msg}</h2>`;
            if (data.results) {
              data.results.forEach((item) => {
                articleListDiv.innerHTML += createListItemHtml(item);
              });
            }
          });
    }

    function loadDetail(id) {
      fetch(`/detail/${id}/`)
        .then((res) => res.json())
        .then((data) => {
          
          const defaultUserImage = "{% static 'articles/images/default_user.png' %}";
          const imgUrl = data.member_image ? data.member_image : defaultUserImage;
          const kanaStr = data.member_kana ? `(${data.member_kana})` : "";
          const roleStr = data.member_role ? `/ ${data.member_role}` : "";
          const dateStr = data.sermon_at ? data.sermon_at : "";

            const statusHtml = `
            <div class="list-image-container">
              <img src="${imgUrl}" alt="${data.member_name}">
            </div>
            <div class="list-content">
              <div class="list-meta">
                ${dateStr} <br>
                ${data.member_name || 'Unknown'} ${kanaStr} ${roleStr}
              </div>
              
              <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                  <div class="list-title" style="font-size: 1.1rem; line-height: 1.2;">
                    ${data.content_title}
                  </div>
                  <div style="margin-left: 10px; font-size: 0.85rem; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 40%;">
                    ${data.content_summary}
                  </div>
              </div>

            </div>
          `;
          
          statusText.innerHTML = statusHtml;

          document.getElementById("displayArea").innerHTML = `
          <h2 class="content_title">${data.content_title}</h2>
          <div class="section-box content_summary">${data.content_summary}</div>
          <div class="section-box ">${data.content_scripture}</div>
          <div class="section-box content_sermon_translate">${data.content_sermon_translate}</div>
          <div class="section-box ">${data.content_tips}</div>
          `;
          
          if (window.innerWidth <= 1024) {
              articleListDiv.classList.remove("show");
              window.scrollTo(0, 0); 
          }
        });
    }

    document.getElementById("search-Input").addEventListener("keydown", function (e) {
         if (e.key !== "Enter") return;
         e.preventDefault();
         const q = e.target.value;
         
         if (window.innerWidth <= 1024) {
             articleListDiv.classList.remove("show");
         }

         if (q.length == 0) {
            resetToInitial();
         } else {
            fetch(`/search/?q=${encodeURIComponent(q)}`)
              .then((res) => res.json())
              .then((data) => {
                const displayArea = document.getElementById("displayArea");
                
                articleListDiv.innerHTML = ""; 
                displayArea.innerHTML = "";
                
                if (window.innerWidth <= 1024) {
                    displayArea.scrollTop = 0; 
                    window.scrollTo(0, 0);
                }

                if (data.results && data.results.length > 0) {
                    displayArea.innerHTML = `<h2 class="content_title" style="font-size:1.5rem; text-align:center;">查找结果: "${q}"</h2>`;

                    data.results.forEach((item) => {
                        articleListDiv.innerHTML += createListItemHtml(item);
                        
                        // item.content_summary が無い場合のガードも入れています
                        const summaryText = item.content_summary ? item.content_summary : "";

                        displayArea.innerHTML += `
                        <div class="section-box" onclick="loadDetail('${item.id}')" style="cursor:pointer; transition: background 0.2s;">
                          
                          <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 10px;">
                              <h3 style="font-size:1.2rem; color:#2c3e50; font-weight:bold; margin:0;">
                                ${item.content_title}
                              </h3>
                              <div style="font-size: 0.85rem; color: #888; margin-left: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 40%;">
                                ${summaryText}
                              </div>
                          </div>

                          <div style="font-size:0.95rem; color:#555; line-height:1.6; margin-bottom:8px;">
                            ${item.snippet}
                          </div>
                          <div style="text-align:right; font-size:0.85rem; color:#999;">
                             ${item.sermon_at} / ${item.member_name}
                          </div>
                        </div>`;
                    });
                } else {
                    displayArea.innerHTML = `<h2 class="content_title">查找结果</h2><div class="section-box">没有找到相关文章。</div>`;
                }
            });
         }
    });
    document.getElementById("search-Input").addEventListener("input", function (e) {
        if (e.target.value === "") resetToInitial();
    });
</script>
</body>
</html>